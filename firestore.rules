// Firestore Security Rules for KAYA Fitness App
// Copy this content to Firebase Console > Firestore Database > Rules

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if the request is coming from the user themselves
    function isCurrentUser(userId) {
      return request.auth.uid == userId;
    }
    
    // Validate timestamp
    function isValidTimestamp(field) {
      return field is timestamp || field == request.time;
    }
    
    // ==================== GAME SCORES ====================
    
    match /gameScores/{scoreId} {
      // Anyone can read scores (for leaderboards)
      allow read: if true;
      
      // Only authenticated users can create their own scores
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'userName', 'gameType', 'level', 'score', 'duration', 'gameData'])
        && request.resource.data.score is number
        && request.resource.data.score >= 0
        && request.resource.data.duration is number
        && request.resource.data.duration >= 0;
      
      // Users cannot update or delete scores (prevents cheating)
      allow update, delete: if false;
    }
    
    // ==================== LEADERBOARDS ====================
    
    match /leaderboards/{leaderboardId} {
      // Anyone can read leaderboards
      allow read: if true;
      
      // Only server/cloud functions can write (prevents manipulation)
      // For now, allow authenticated users to update
      allow write: if isAuthenticated();
    }
    
    // ==================== USER GAME STATS ====================
    
    match /userGameStats/{userId} {
      // Users can only read their own stats
      allow read: if isCurrentUser(userId);
      
      // Users can create/update their own stats
      allow create, update: if isCurrentUser(userId);
      
      // Cannot delete stats
      allow delete: if false;
    }
    
    // ==================== USER PROFILES ====================
    
    match /users/{userId} {
      // Users can read any profile (for leaderboards, social features)
      allow read: if true;
      
      // Users can only write their own profile
      allow create, update: if isCurrentUser(userId);
      allow delete: if false;
    }
    
    match /profiles/{userId} {
      allow read: if true;
      allow create, update: if isCurrentUser(userId);
      allow delete: if false;
    }
    
    // ==================== HEALTH DATA ====================
    
    match /healthData/{userId} {
      // Only the user can read/write their health data
      allow read, write: if isCurrentUser(userId);
    }
    
    // ==================== WORKOUT HISTORY ====================
    
    match /workoutHistory/{sessionId} {
      // Users can only read their own workout history
      allow read: if isAuthenticated() 
        && resource.data.userId == request.auth.uid;
      
      // Users can create their own workout sessions
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      // Cannot update or delete workout history
      allow update, delete: if false;
    }
    
    // ==================== USER SETTINGS ====================
    
    match /userSettings/{userId} {
      allow read, write: if isCurrentUser(userId);
    }
    
    // ==================== CHALLENGES ====================
    
    match /challenges/{challengeId} {
      // Anyone can read challenges
      allow read: if true;
      
      // Only admins can create/update challenges (implement admin check)
      allow write: if false;
    }
    
    // ==================== BADGES ====================
    
    match /badges/{badgeId} {
      // Anyone can read badges
      allow read: if true;
      
      // Only server can write
      allow write: if false;
    }
    
    // User's earned badges
    match /userBadges/{userId}/badges/{badgeId} {
      allow read: if true;
      allow write: if isCurrentUser(userId);
    }
  }
}
